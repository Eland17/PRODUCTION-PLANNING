<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Planning Produksi</title>
<style>
body { font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; background: #e9e7dd; margin:0; padding:20px; }
.card { background:#fff; border:1px solid #ccc; border-radius:4px; box-shadow:0 2px 5px rgba(0,0,0,0.08); padding:15px; max-width:1100px; margin:auto; }
h1 { font-size:18px; margin:0 0 10px; }
.header-actions { display:flex; justify-content:flex-end; gap:8px; margin-bottom:10px; }
.btn { background:#f8f9fa; border:1px solid #ccc; border-radius:4px; font-size:12px; padding:6px 10px; cursor:pointer; transition:0.2s; }
.btn:hover { background:#f0f0f0; }
.btn.primary { background:#007bff; color:white; border-color:#007bff; }
table { width:100%; border-collapse:collapse; font-size:12px; }
th, td { border:1px solid #ddd; padding:6px 8px; }
th { background:#f3f3f3; text-align:center; }
td { text-align:left; }
td.right { text-align:right; }
td.center { text-align:center; }
tr:nth-child(even){ background:#fafafa; }
.pill { padding:3px 6px; border-radius:4px; font-size:11px; }
.pill.green { background:#d4edda; color:#155724; }
.pill.red { background:#f8d7da; color:#721c24; }
.background-green { background-color:#d4edda; }
.background-red { background-color:#f8d7da; }

/* Popup Form */
.overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); display:none; justify-content:center; align-items:center; z-index:10; }
.popup { background:#fff; border-radius:6px; padding:20px; width:95%; max-width:650px; box-shadow:0 4px 10px rgba(0,0,0,0.3); }
.popup h2 { margin-top:0; font-size:16px; text-align:center; border-bottom:1px solid #ddd; padding-bottom:6px; margin-bottom:15px; }
form { display:grid; grid-template-columns:1fr 1fr; gap:10px; font-size:12px; }
label { display:block; margin-bottom:3px; color:#333; }
input, select, textarea { width:100%; padding:5px 8px; border:1px solid #ccc; border-radius:4px; font-size:12px; box-sizing:border-box; }
textarea { resize: vertical; }
.form-actions { grid-column: span 2; display:flex; justify-content:flex-end; gap:6px; margin-top:5px; }

/* Material Table in Form */
#materialTable { width:100%; border-collapse: collapse; margin-top:5px; font-size:12px; }
#materialTable th, #materialTable td { border:1px solid #ddd; padding:4px 6px; }
#materialTable th { background:#f3f3f3; text-align:center; }
#materialTable td { text-align:left; }
#materialTable td.center { text-align:center; }
.remove-btn { color:red; cursor:pointer; font-size:12px; }

/* Popup Keterangan */
.ket-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); display:none; justify-content:center; align-items:center; z-index:20; }
.ket-popup { background:#fff; border-radius:6px; padding:15px; width:90%; max-width:400px; box-shadow:0 4px 10px rgba(0,0,0,0.3); font-size:12px; }
.ket-popup h3 { margin-top:0; font-size:14px; text-align:center; border-bottom:1px solid #ddd; padding-bottom:6px; margin-bottom:10px; }
.ket-popup table { width:100%; border-collapse: collapse; margin-top:10px; font-size:12px; }
.ket-popup th, .ket-popup td { border:1px solid #ddd; padding:4px 6px; }
.ket-popup th { background:#f3f3f3; text-align:center; }
.ket-popup td { text-align:left; }
.ket-popup td.center { text-align:center; }

@media (max-width:600px){ form{grid-template-columns:1fr;} }
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
<div class="card">
<h1>Production Planning</h1>
<div class="header-actions">
  <button class="btn primary" id="openPopup">+ Add Plan</button>
  <button class="btn" id="printPreviewBtn">Print Preview</button>
</div>

<table id="plansTable">
  <thead>
    <tr>
      <th>Line</th>
      <th>Buyer</th>
      <th>Style</th>
      <th>Description</th>
      <th>PO</th>
      <th class="right">Qty</th>
      <th class="right">Target (pcs/hari)</th>
      <th>Start Sew</th>
      <th>End Sew</th>
      <th>Delivery</th>
      <th>Status</th>
      <th>Keterangan</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
</div>

<!-- Popup Form -->
<div class="overlay" id="overlay">
  <div class="popup">
    <h2>Tambah Rencana Produksi</h2>
    <form id="planForm" onsubmit="return false;">
      <div><label>Line</label><input id="line"></div>
      <div><label>Buyer</label><input id="buyer" required></div>
      <div><label>Style</label><input id="style" required></div>
      <div><label>Description</label><input id="description"></div>
      <div><label>PO Number</label><input id="po"></div>
      <div><label>Qty Order</label><input id="qty" type="number"></div>
      <div><label>Target (pcs/hari)</label><input id="target_day" type="number" min="1"></div>
      <div><label>Start Sew</label><input id="start_sew" type="date"></div>
      <div><label>End Sew (otomatis)</label><input id="end_sew" type="date" readonly></div>
      <div><label>Delivery Date</label><input id="del_date" type="date"></div>
      <div>
        <label>Status</label>
        <select id="status">
          <option value="Planned">Planned</option>
          <option value="On Progress">On Progress</option>
          <option value="Finished">Finished</option>
          <option value="Delay">Delay</option>
        </select>
      </div>
      <div style="grid-column: span 2;">
        <label>Status Keterangan</label>
        <select id="status_ket">
          <option value=""></option>
          <option value="Complete">Completed</option>
          <option value="Major Issue">Major Issue</option>
          <option value="Minor Issue">Minor Issue</option>
        </select>
        <label style="margin-top:5px;">Keterangan Tambahan</label>
        <textarea id="keterangan" rows="2" placeholder="Tambahkan keterangan tambahan"></textarea>
      </div>
      <div style="grid-column: span 2;">
        <label>Detail Material</label>
        <button type="button" class="btn" style="margin-bottom:5px;" id="addMaterialBtn">+ Add Material</button>
        <table id="materialTable">
          <thead><tr><th>Material</th><th>Satuan</th><th>Qty</th><th>Action</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="form-actions">
        <button type="button" class="btn" id="cancelPopup">Cancel</button>
        <button type="submit" class="btn primary" id="addBtn">Add</button>
      </div>
    </form>
  </div>
</div>

<!-- Popup Keterangan -->
<div class="ket-overlay" id="ketOverlay">
  <div class="ket-popup">
    <h3>Detail Keterangan</h3>
    <div id="ketContent"></div>
    <div style="text-align:center; margin-top:10px;">
      <button class="btn" onclick="closeKetPopup()">Close</button>
    </div>
  </div>
</div>

<script>
// ======================= FIREBASE ===========================
const firebaseConfig = {
  apiKey: "AIzaSyACOluEhfPw4JBlBaHyXtf1k3TIJAHikKo",
  authDomain: "inventory-gudang-16dfe.firebaseapp.com",
  projectId: "inventory-gudang-16dfe",
  storageBucket: "inventory-gudang-16dfe.appspot.com",
  messagingSenderId: "663364522026",
  appId: "1:663364522026:web:6ee9d76e506d6cf43eb289"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const $ = id => document.getElementById(id);
const tbody = document.querySelector("#plansTable tbody");
let plans = [];

// ==================== RENDER ===============================
function render(){
  tbody.innerHTML="";
  const lineOrder = ["2","2A","2B","3","4","5","6","7"];
  plans.sort((a,b)=>{
    const idxA=lineOrder.indexOf(a.line)!=-1?lineOrder.indexOf(a.line):100;
    const idxB=lineOrder.indexOf(b.line)!=-1?lineOrder.indexOf(b.line):100;
    return idxA-idxB;
  });
  const todayStr=new Date().toISOString().slice(0,10);
  plans.forEach(p=>{
    const startClass = (p.start_sew===todayStr)?"background-green":"";
    const endClass = (p.end_sew===todayStr)?"background-red":"";
    const materialData=p.material||[];
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td class="center">${p.line||""}</td>
      <td class="center">${p.buyer||""}</td>
      <td class="center">${p.style||""}</td>
      <td class="center">${p.description||""}</td>
      <td class="center">${p.po||""}</td>
      <td class="right">${p.qty?.toLocaleString()||""}</td>
      <td class="right">${p.target_day||""}</td>
      <td class="${startClass}">${p.start_sew||""}</td>
      <td class="${endClass}">${p.end_sew||""}</td>
      <td>${p.del_date||""}</td>
      <td>${statusPill(p.status)}</td>
      <td>
        <span style="cursor:pointer;color:blue;text-decoration:underline;"
          onclick='showKeterangan("${(p.keterangan||"").replace(/"/g,"&quot;")}", ${JSON.stringify(materialData)})'>
          ${p.status_ket||"-"}
        </span>
      </td>
      <td>
        <button class="btn" onclick='editPlan("${p.id}")'>Edit</button>
        <button class="btn" style="color:red;" onclick='deletePlan("${p.id}")'>Del</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

function statusPill(status){
  if(!status) return '<span class="pill">Planned</span>';
  if(status==="Finished") return '<span class="pill green">Finished</span>';
  if(status==="Delay") return '<span class="pill red">Delay</span>';
  return `<span class="pill">${status}</span>`;
}

// ==================== HITUNG END SEW =======================
function computeEndSew(startStr, qty, target){
  if(!startStr||!qty||!target) return "";
  const totalDays=Math.ceil(qty/target);
  let date=new Date(startStr+"T00:00:00"); let added=0;
  while(added<totalDays-1){
    date.setDate(date.getDate()+1);
    if(date.getDay()!=0 && date.getDay()!=6) added++;
  }
  const yyyy=date.getFullYear(), mm=String(date.getMonth()+1).padStart(2,"0"), dd=String(date.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}

// ==================== UPDATE END SEW OTOMATIS ===================
function updateEndSew() {
  const start = $("start_sew").value;
  const qty = Number($("qty").value);
  const target = Number($("target_day").value);
  $("end_sew").value = computeEndSew(start, qty, target);
}

// Event listener supaya End Sew update otomatis
$("start_sew").addEventListener("change", updateEndSew);
$("qty").addEventListener("input", updateEndSew);
$("target_day").addEventListener("input", updateEndSew);

// ==================== FORM & MATERIAL ======================
function collectForm(){
  const start=$("start_sew").value, qty=Number($("qty").value), target=Number($("target_day").value);
  const computedEnd=computeEndSew(start, qty, target);
  const matRows=document.querySelectorAll("#materialTable tbody tr");
  const material=Array.from(matRows).map(r=>({
    item:r.querySelector(".mat-item").value,
    satuan:r.querySelector(".mat-satuan").value,
    qty:Number(r.querySelector(".mat-qty").value)
  }));
  return {
    line:$("line").value.trim(),
    buyer:$("buyer").value.trim(),
    style:$("style").value.trim(),
    description:$("description").value.trim(),
    po:$("po").value.trim(),
    qty, target_day:target,
    start_sew:start, end_sew:computedEnd,
    del_date:$("del_date").value,
    status:$("status").value,
    status_ket:$("status_ket").value,
    keterangan:$("keterangan").value.trim(),
    material
  };
}

function addMaterialRow(item="", satuan="", qty=""){
  const tbodyMat=document.querySelector("#materialTable tbody");
  const tr=document.createElement("tr");
  tr.innerHTML=`<td><input class="mat-item" value="${item}" placeholder="Material"></td>
    <td class="center"><input class="mat-satuan" value="${satuan}" placeholder="Satuan" style="text-align:center;"></td>
    <td class="center"><input class="mat-qty" type="number" value="${qty}" min="0" style="text-align:center;"></td>
    <td><span class="remove-btn" onclick="this.closest('tr').remove()">Remove</span></td>`;
  tbodyMat.appendChild(tr);
}
$("addMaterialBtn").onclick=()=>addMaterialRow();

// ==================== FIRESTORE ===========================
function loadPlans(){
  db.collection("planning_produksi").orderBy("start_sew").get()
  .then(snap=>{
    plans = snap.docs.map(doc=>({id:doc.id,...doc.data()}));
    render();
  });
}

function savePlan(data, id){
  if(id){
    db.collection("planning_produksi").doc(id).set(data).then(()=>loadPlans());
  } else {
    db.collection("planning_produksi").add(data).then(()=>loadPlans());
  }
}

function deletePlan(id){
  if(confirm("Hapus data ini?")){
    db.collection("planning_produksi").doc(id).delete().then(()=>loadPlans());
  }
}

function editPlan(id){
  const p = plans.find(x=>x.id===id);
  $("line").value = p.line||"";
  $("buyer").value = p.buyer||"";
  $("style").value = p.style||"";
  $("description").value = p.description||"";
  $("po").value = p.po||"";
  $("qty").value = p.qty||"";
  $("target_day").value = p.target_day||"";
  $("start_sew").value = p.start_sew||"";
  $("end_sew").value = p.end_sew||"";
  $("del_date").value = p.del_date||"";
  $("status").value = p.status||"Planned";
  $("status_ket").value = p.status_ket||"";
  $("keterangan").value = p.keterangan||"";
  document.querySelector("#materialTable tbody").innerHTML="";
  (p.material||[]).forEach(m=>addMaterialRow(m.item,m.satuan,m.qty));
  $("addBtn").textContent="Save";
  openPopup();
  $("addBtn").onclick=()=>{
    const data=collectForm(); 
    savePlan(data,id); 
    closePopup(); 
    clearForm(); 
    $("addBtn").textContent="Add"; 
    $("addBtn").onclick=defaultAdd;
  }
}

function defaultAdd(){ const data=collectForm(); savePlan(data); closePopup(); clearForm(); }
function clearForm(){ $("planForm").reset(); document.querySelector("#materialTable tbody").innerHTML=""; $("end_sew").value=""; }
function openPopup(){ $("overlay").style.display="flex"; }
function closePopup(){ $("overlay").style.display="none"; }
$("openPopup").onclick=openPopup;
$("cancelPopup").onclick=closePopup;
$("addBtn").onclick=defaultAdd;

// ==================== POPUP KETERANGAN =====================
function showKeterangan(ket, material){
  const ketContent = $("ketContent");
  let html = "";
  if(ket) html += `<p><strong></strong> ${ket}</p>`;
  if(material && material.length){
    html += `<table>
      <thead><tr><th>Material</th><th>Satuan</th><th>Qty</th></tr></thead>
      <tbody>`;
    material.forEach(m=>{
      html += `<tr>
        <td>${m.item||""}</td>
        <td class="center">${m.satuan||""}</td>
        <td class="center">${m.qty||""}</td>
      </tr>`;
    });
    html += `</tbody></table>`;
  }
  ketContent.innerHTML = html || "<p>-</p>";
  $("ketOverlay").style.display = "flex";
}

function closeKetPopup(){
  $("ketOverlay").style.display = "none";
}


// ==================== PRINT PREVIEW =======================
$("printPreviewBtn").onclick = () => {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("portrait", "mm", "a4"); // portrait
  doc.setFontSize(12);
  doc.setTextColor(0,0,0);
  doc.text("Production Planning", 105, 10, { align: "center" });

  const rows = plans.map(p => [
    p.line || "", 
    p.buyer || "", 
    p.style || "", 
    p.description || "", 
    p.po || "",
    p.qty?.toLocaleString() || "", 
    p.target_day || "", 
    p.start_sew || "", 
    p.end_sew || "", 
    p.del_date || ""
  ]);

  doc.autoTable({
    startY: 18,
    head: [["Line","Buyer","Style","Description","PO","Qty","Target","Start","End","Delivery"]],
    body: rows,
    theme: 'grid',
    styles: { fontSize: 7, textColor: 0, cellPadding: 2 }, // teks hitam untuk semua
    headStyles: { fillColor: [169,169,169], textColor: 0, halign:'center', fontStyle:'bold' },
    columnStyles: { 
      0:{halign:'center', cellWidth: 12}, 
      1:{halign:'center', cellWidth: 20}, 
      2:{halign:'center', cellWidth: 20}, 
      3:{halign:'center', cellWidth: 38}, 
      4:{halign:'center', cellWidth: 20}, 
      5:{halign:'right', cellWidth: 15},  
      6:{halign:'right', cellWidth: 15},  
      7:{halign:'center', cellWidth: 18}, 
      8:{halign:'center', cellWidth: 18}, 
      9:{halign:'center', cellWidth: 25}  
    },
    tableLineColor: [0,0,0],
    margin: { left: 5, right: 5 }
  });

  const pdfBlob = doc.output('blob');
  const url = URL.createObjectURL(pdfBlob);
  window.open(url, '_blank');
}


// ==================== LOAD ===============================
loadPlans();
</script>
</body>
</html>
